<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{default}">

<body>

<!-- 이 한 줄이 사이드바를 제거합니다 -->
<div layout:fragment="aside"></div>

<div layout:fragment="content">
    <div class="container-fluid mt-3">
        <h2>새 글 작성</h2>
        <form id="postForm"
              th:action="@{/blog/list/{domain}/savePost(domain=${domain})}"
              th:object="${post}" method="post">

            <div class="mb-3">
                <label>글 제목</label>
                <input class="form-control" th:field="*{title}" placeholder="제목 입력" required/>
            </div>

            <div class="mb-3">
                <label>본문</label>
                <div id="editorjs" style="min-height:300px;background:#fafafa;"></div>
                <input type="hidden" name="content" id="content"/>
            </div>

            <div class="mb-3">
                <label>메뉴</label>
                <select class="form-select" th:field="*{menu}" required>
                    <option value="">--- 메뉴 선택 ---</option>
                    <th:block th:each="menu : ${menus}">
                        <option th:value="${menu.no}" th:text="${menu.name}"></option>
                    </th:block>
                </select>
            </div>

            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary me-2">저장</button>
                <button type="button" class="btn btn-danger" onclick="history.back()">취소</button>
            </div>
        </form>
    </div>
</div>

<!-- EditorJS + axios CDN -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/attaches@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/raw@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/table@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/nested-list@latest"></script>

<script>
    async function uploadFile(file) {
      const fd = new FormData();
      fd.append('file', file);
      const { data } = await axios.post('/file/upload', fd);
      return { success: data.success, file: { url: data.file.url } };
    }

    const editor = new EditorJS({
      holder: 'editorjs',
      tools: {
        paragraph: Paragraph,
        header: Header,
        image: { class: ImageTool, config: { uploader: { uploadByFile: uploadFile } } },
        attaches: { class: AttachesTool, config: { uploader: { uploadByFile: uploadFile } } },
        checklist: Checklist,
        code: CodeTool,
        raw: RawTool,
        marker: Marker,
        quote: Quote,
        table: Table,
        list: NestedList
      }
    });

    document.getElementById('postForm').addEventListener('submit', async e => {
      e.preventDefault();
      const saved = await editor.save();
      document.getElementById('content').value = JSON.stringify(saved.blocks);
      e.target.submit();
    });
</script>
</body>
</html>
